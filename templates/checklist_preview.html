{% load static %}
{% load custom_tags %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="{% static 'pwa/manifest.json' %}">
  <meta name="theme-color" content="#002550">
  <link rel="apple-touch-icon" href="{% static 'pwa/icons/icon-192.png' %}">
  <title>Preview - {{ report_type }}</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <style>
    :root {
      --brand:#002550;
      --bg1:#a1c4fd;
      --bg2:#c2e9fb;
      --shadow:0 2px 4px rgba(0,0,0,.1);
      --mheader-h:56px;
      --mfooter-h:56px;
      --navbar-h:60px;
    }

    body {
      margin: 0;
      font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(120deg, var(--bg1) 0%, var(--bg2) 100%);
      background-attachment: fixed;
      min-height: 100vh;
      display:flex; flex-direction:column;
    }

    /* ===== Desktop Navbar ===== */
    .navbar {
      display:flex; justify-content:space-between; align-items:center;
      background:#fff; padding:10px 20px;
      height:var(--navbar-h); box-shadow:var(--shadow); z-index:1000;
    }
    @media(min-width:769px){
      .navbar {position:fixed; top:0; left:0; right:0;}
      body {padding-top:var(--navbar-h);}
    }
    .logo {height:40px;}
    .nav-links {display:flex; gap:24px; align-items:center;}
    .nav-links a {
      display:flex; flex-direction:column; align-items:center;
      text-decoration:none; color:var(--brand); font-weight:600;
      font-size:12px;
    }
    .nav-links i {font-size:18px;}

    /* ===== Mobile Header ===== */
    .mobile-header {
      display:none; position:fixed; top:0; left:0; right:0;
      height:var(--mheader-h); background:#fff;
      box-shadow:var(--shadow); padding:8px 12px;
      z-index:1000; align-items:center; justify-content:space-between;
    }
    .m-left img {height:32px;}
    .icon-btn {
      background:#f3f4f6; border:none; border-radius:8px; padding:8px 10px;
      cursor:pointer; color:var(--brand); display:inline-flex; align-items:center;
      justify-content:center;
    }

    /* ===== Mobile Footer ===== */
    .mobile-footer {
      display:none; position:fixed; bottom:0; left:0; right:0;
      height:var(--mfooter-h); background:#fff;
      box-shadow:0 -2px 4px rgba(0,0,0,.1);
      align-items:center; justify-content:space-around; z-index:1000;
    }
    .mobile-footer a {
      text-decoration:none; color:var(--brand);
      display:flex; flex-direction:column; align-items:center;
      font-size:12px; font-weight:600;
    }
    .mobile-footer i {font-size:18px; margin-bottom:4px;}
    @media(max-width:768px){
      .navbar{display:none;}
      .mobile-header{display:flex;}
      .mobile-footer{display:flex;}
      body{padding-top:var(--mheader-h); padding-bottom:var(--mfooter-h);}
    }

    /* ===== Preview Container ===== */
    .content {flex:1; overflow:auto; padding:20px;}
    .preview-card {
      max-width:900px; margin:30px auto;
      background:#fff; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.1);
      padding:25px 30px;
    }
    .preview-title {text-align:center; color:var(--brand); margin-bottom:20px;}

    .preview-details {
      display:flex; flex-wrap:wrap; gap:30px; margin-bottom:20px;
    }
    .preview-details div {flex:1; min-width:250px;}
    .preview-details p {margin:6px 0; color:#333;}

    /* ===== Table ===== */
    table.preview-table {
      width:100%; border-collapse:collapse; margin-top:15px;
      background:#fff;
    }
    table.preview-table th, table.preview-table td {
      border:1px solid #ccc; padding:10px; text-align:left;
    }
    table.preview-table th {background:#f4f6fb; color:var(--brand);}

    /* ===== Image Grid ===== */
    .image-grid {
      display:flex; flex-wrap:wrap; gap:16px; margin-top:15px;
    }
    .image-box {
      width:calc(33.33% - 16px);
      text-align:center;
    }
    .preview-image {
      width:100%; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.2);
      cursor:pointer; transition:transform 0.3s ease;
      max-height:200px; object-fit:cover;
    }
    .preview-image:hover {transform:scale(1.03);}
    @media(max-width:768px){.image-box{width:calc(50% - 16px);}}
    @media(max-width:480px){.image-box{width:100%;}}

    /* ===== Comments & Signatures ===== */
    .comments-box {
      background:#f9f9f9; padding:12px; border-radius:6px;
      border:1px solid #ddd; margin:15px 0; color:#333;
    }
    .signatures {
      display:flex; justify-content:space-between; flex-wrap:wrap;
      gap:30px; margin-top:20px;
    }
    .sign-box {flex:1; min-width:250px; text-align:center;}
    .sign-box img {
      max-width:250px; max-height:250px; border-radius:8px; border:1px solid #ccc;
      cursor:zoom-in;
    }

    /* ===== Buttons ===== */
    .action-buttons {
      display:flex; flex-wrap:wrap; gap:12px; margin-top:25px;
    }
    .action-buttons button, .download-btn {
      flex:1; min-width:120px; padding:10px 16px;
      border:none; border-radius:6px; font-weight:600; color:#fff;
      cursor:pointer; transition:background-color 0.3s ease;
    }
    .edit-btn {background:#ffc107;}
    .edit-btn:hover{background:#866603;}
    .save-btn {background:#28a745;}
    .save-btn:hover{background:#033d0f;}
    .download-btn {background:#007bff; display:inline-block; text-align:center; text-decoration:none;}
    .download-btn:hover{background:#0056b3;}

    /* ===== Modal Styles ===== */
    .modal {
      display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.9); z-index:9999; align-items:center; justify-content:center;
    }
    .modal img {
      max-width:85%; max-height:80%; border-radius:10px;
    }
    .close {
      position:absolute; top:20px; right:35px; color:#fff;
      font-size:40px; cursor:pointer;
    }
  </style>
</head>
<body>

  <!-- ===== Desktop Navbar ===== -->
  <div class="navbar">
    <img src="{% static 'Images/logo.png' %}" alt="Logo" class="logo">
    <div class="nav-links">
      <a href="{% url 'add_checklist_item' %}"><i class="fas fa-plus-circle"></i><span>Add Checklist</span></a>
      <a href="{% url 'history_servicereport' %}"><i class="fas fa-history"></i><span>History</span></a>
    </div>
  </div>

  <!-- ===== Mobile Header ===== -->
  <div class="mobile-header">
    <div class="m-left"><img src="{% static 'Images/logo.png' %}" alt="Logo"></div>
    <div class="m-right">
      <a class="icon-btn" href="{% url 'add_checklist_item' %}"><i class="fas fa-plus-circle"></i></a>
      <a class="icon-btn" href="{% url 'history_servicereport' %}"><i class="fas fa-history"></i></a>
    </div>
  </div>

  <!-- ===== Main Content ===== -->
  <div class="content">
    <div class="preview-card">
      <h2 class="preview-title">Preview ‚Äì Preventive Maintenance Inspection Checklist ‚Äì {{ component }}</h2>

      <div class="preview-details">
        <div>
          <p><strong>Project:</strong> {{ preview_data.project_name }}</p>
          <p><strong>Location:</strong> {{ preview_data.project_location }}</p>
          <p><strong>Department:</strong> Operations & Maintenance</p>
          <p><strong>Inspection Date:</strong> {{ preview_data.inspection_date }}</p>
          <p><strong>Period:</strong> {{ preview_data.period_of_inspection }}</p>
          <p><strong>Next Inspection:</strong> {{ preview_data.next_inspection_date }}</p>
        </div>
        <div>
          <p><strong>Date of Issue:</strong> {{ Date }}</p>
          <p><strong>Format No:</strong> {{ format_no }}</p>
          <p><strong>Make:</strong> {{ preview_data.make }}</p>
          <p><strong>Type:</strong> {{ preview_data.Type }}</p>
          <p><strong>S.No:</strong> {{ preview_data.s_no }}</p>
          <p><strong>Rating:</strong> {{ preview_data.rating }}</p>
        </div>
      </div>

      <h3>Checklist</h3>
      <table class="preview-table">
        <thead><tr><th>S.No.</th><th>Checkpoint</th><th>Status</th><th>Remark</th></tr></thead>
        <tbody>
          {% for item in checklist %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ item.checklist_item.checkpoint }}</td>
            <td>{{ item.status }}</td>
            <td>{{ item.remark }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <h3>Uploaded Images (1‚Äì6)</h3>
      <div class="image-grid">
        {% for i in "123456" %}
          {% with image_field="image"|add:i %}
            {% with image=preview_data|attr:image_field %}
              {% if image %}
                <div class="image-box">
                  <p><strong>Image {{ i }}</strong></p>
                  <img src="{{ image.url }}" class="preview-image" onclick="openImageModal(this.src)">
                </div>
              {% endif %}
            {% endwith %}
          {% endwith %}
        {% endfor %}
      </div>

      <div class="signatures">
        <div class="sign-box">
          <h3>Authorized Signatory (Customer)</h3>
          <p><strong>Name:</strong> {{ preview_data.customer_name }}</p>
          {% if preview_data.signature %}
            <img src="{{ preview_data.signature.url }}" onclick="openImageModal(this.src)">
          {% elif preview_data.signature_pad_data %}
            <img src="{{ preview_data.signature_pad_data }}" onclick="openImageModal(this.src)">
          {% else %}<p>Not uploaded</p>{% endif %}
        </div>

        <div class="sign-box">
          <h3>Authorized Signatory (SOLON)</h3>
          <p><strong>Name:</strong> {{ preview_data.solon_name }}</p>
          {% if preview_data.signature1 %}
            <img src="{{ preview_data.signature1.url }}" onclick="openImageModal(this.src)">
          {% elif preview_data.signature_pad_data1 %}
            <img src="{{ preview_data.signature_pad_data1 }}" onclick="openImageModal(this.src)">
          {% else %}<p>Not uploaded</p>{% endif %}
        </div>
      </div>

      <p><strong>Comments:</strong></p>
      <div class="comments-box">{{ comments|linebreaksbr }}</div>
      <p><strong>Send To:</strong> {{ preview_data.email_to }}</p>

      <form method="post" class="action-buttons">
        {% csrf_token %}
        <input type="hidden" name="report_type" value="{{ report_type }}">
        <input type="hidden" name="edit_id" value="{{ preview_data.id }}">
        <input type="hidden" name="email_to" value="{{ email_to }}">
        <button type="submit" name="edit" class="edit-btn">‚úèÔ∏è Edit</button>
        <button type="submit" name="final_save" class="save-btn">üíæ Save & Submit</button>
      </form>
    </div>
  </div>

  <!-- ===== Mobile Footer ===== -->
  <div class="mobile-footer">
    <a href="{% url 'add_checklist_item' %}"><i class="fas fa-plus-circle"></i><span>Add</span></a>
    <a href="{% url 'history_servicereport' %}"><i class="fas fa-history"></i><span>History</span></a>
  </div>

  <!-- ===== Image Modal ===== -->
  <div id="imgModal" class="modal">
    <span class="close" onclick="closeImageModal()">&times;</span>
    <img id="modalImg" src="">
  </div>

  <!-- ===== Success Modal ===== -->
  <div id="successModal" class="modal">
    <div style="background:#fff; padding:30px; border-radius:10px; width:90%; max-width:480px; text-align:center; position:relative;">
      <span class="close" onclick="closeModal()">&times;</span>
      <h3 style="color:green;">‚úÖ Service Report saved & shared successfully!</h3>
      {% if preview_data.id %}
      <a href="{% url 'download_pdf' preview_data.id %}" class="download-btn" target="_blank">‚¨áÔ∏è Download PDF</a>
      {% endif %}
    </div>
  </div>

  <script>
    function openImageModal(src){
      const modal=document.getElementById('imgModal');
      const img=document.getElementById('modalImg');
      img.src=src; modal.style.display='flex';
    }
    function closeImageModal(){document.getElementById('imgModal').style.display='none';}
    function closeModal(){document.getElementById('successModal').style.display='none';}

    const showModal="{{ show_modal|yesno:'true,false' }}";
    if(showModal==="true"){window.onload=()=>{document.getElementById('successModal').style.display='flex';};}

    if('serviceWorker' in navigator){
      window.addEventListener('load',()=>{navigator.serviceWorker.register('/service-worker.js');});
    }
  </script>
</body>
</html>
