<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complaint Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <style>
        body {
            font-family: Verdana, Geneva, Tahoma, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            color: #333;
            height: 100vh;
            overflow: auto;
            position: relative;
        }
        body::before {
            content: "";
            position: fixed;
            top: 10%;
            left: 0;
            width: 100%;
            height: calc(100vh - 4px);
            background-image: url('/static/Images/solon2.jpg');
            filter: blur(3px);
            background-size: cover;
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-position: center;
            z-index: -1;
        }
        .button-container {
            text-align: left;
            position: fixed;
            top: 11%;
            left: 0;
            background-color: rgba(2, 37, 70, 0.7);
            height: 90%;
            width: 15%;
            padding: 10px;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(1px);
        }
        .button-container a {
            color: white;
            padding: 10px 20px;
            text-align: left;
            text-decoration: none;
            font-size: 16px;
            border-radius: 5px;
            display: block;
            transition: background-color 0.3s, text-decoration 0.3s;
        }
        .button-container a:hover {
            text-decoration: underline;
        }
        .logo {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 2;
            margin-bottom: 10%;
        }
        .logo img {
            width: 100px;
            height: auto;
        }
        h3 {
            text-align: center;
        }
        .top-right-form {
            position: absolute;
            top: 10%;
            right: 5%;
            z-index: 1000; /* Ensures the form stays on top */
        }

        .top-right-form label {
            margin-right: 8px;
            font-weight: bold;
        }

        .top-right-form select {
            padding: 5px;
            font-size: 14px;
        }
        label {
            font-size: 16px;
            color:darkblue;
        }
        .chart-container {
            width: 80%; /* Adjust the width as needed */
            max-width: 600px; /* Maximum width for the chart */
            margin-left: 20%;
            background-color: #f9f9f9cc; /* Background color of the container (optional) */
            padding: 10px; /* Add some padding around the chart */
            border-radius: 8px; /* Optional: Rounded corners for the container */
        }

        #complaintsComboChart {
            width: 100% !important; /* Ensure the canvas takes the full width of the container */
            height: 400px !important; /* Set a fixed height for the canvas */
        }
        .chart-wrapper {
            display: flex; /* Use flexbox to place the charts side by side */
            justify-content: space-between; /* Reduce the space between the charts */
            align-items: flex-start; /* Align charts to the top */
            gap: 20px; /* Reduce the gap between the two charts */
        }

        .chart-container1 {
            width: 42%; /* Reduce the width of the pie chart */
            margin-top: 8%;
            margin-right: 3%; /* Optional: Add some margin around the containers */
            background-color: #f9f9f9b9; /* Background color (optional) */
            position: relative; /* Position the chart title relative to the container */
        }

        .chart-container2 {
            width: 60%; /* Wider container for the bar chart */
            margin-top: 8%;
            margin-left: 20%; /* Optional: Add some margin around the containers */
            background-color: #f9f9f9b9; /* Background color (optional) */
            position: relative; /* Position the chart title relative to the container */
        }

        .chart-title {
            position: absolute;
            top: -30px;
            left: 28%;
            transform: translateX(-50%);
            font-size: 18px;
            font-weight: bold;
            color: #0f0149;
            padding: 0 10px;
            text-align: center;
        }

        canvas {
            width: 100% !important;
            height: 400px !important; /* Fixed height for both charts */
        }

    </style>
</head>
<body>
    <div class="logo">
        <img src="/static/Images/logo.jpg" alt="Footer Image">
    </div>
    <div class="container">
        <h3>Complaint Analysis</h3>
        <div class="button-container">
            <a href="{% url 'approval_complaints' %}"><b>Approvals</b></a>
            <a href="{% url 'final_complaints' %}"><b>Closed Complaints</b></a>
            <a href="{% url 'admin' %}"><b>Dashboard</b></a>
            <a href="{% url 'home' %}"><b>Home</b></a>
        </div>
        <form method="get" action="{% url 'complaint_analysis' %}" class="top-right-form">
            <label for="site_name">Select Site:</label>
            <select id="site_name" name="site_name" onchange="this.form.submit()">
                <option value="All" {% if selected_site == 'All' %}selected{% endif %}>All Sites</option>
                {% for site in sites %}
                    <option value="{{ site }}" {% if selected_site == site %}selected{% endif %}>{{ site }}</option>
                {% endfor %}
            </select>
        </form>
        <div class="chart-wrapper">
            <!-- Bar Chart -->
            <div class="chart-container2">
                <div class="chart-title">Complaints Tracker</div>
                <canvas id="complaintsComboChart"></canvas>
            </div>
        
            <!-- Pie Chart -->
            <div class="chart-container1">
                <div class="chart-title">Overall Complaints</div>
                <canvas id="totalComplaintsPieChart" width="200" height="200"></canvas>
            </div>
        </div>
    <script>
    // Prepare data for Chart.js
    const years = JSON.parse('{{ years_json|escapejs }}');
    const openCounts = JSON.parse('{{ open_counts_json|escapejs }}');
    const closedCounts = JSON.parse('{{ closed_counts_json|escapejs }}');
    const totalOpen = parseInt('{{ total_open|default:"0" }}');
    const totalClosed = parseInt('{{ total_closed|default:"0" }}');
    // Combo chart for open and closed complaints
    const ctxComplaints = document.getElementById('complaintsComboChart').getContext('2d');
    new Chart(ctxComplaints, {
        type: 'bar',
        data: {
            labels: years, // X-axis labels (years)
            datasets: [
                {
                    label: 'Open Complaints',
                    data: openCounts,
                    backgroundColor: 'rgba(0, 0, 128)', // Transparent blue for bars
                    borderColor: 'rgba(0, 0, 128)', // blue border for bars
                    borderWidth: 1,
                    barThickness: 20,
                    categoryPercentage: 0.4, // Adjust category spacing
                    barPercentage: 0.8 // Adjust bar width
                },
                {
                    label: 'Closed Complaints',
                    data: closedCounts,
                    backgroundColor: 'rgb(0, 128, 0)', // Transparent red for bars
                    borderColor: 'rgba(255, 0, 0)', // red border for bars
                    borderWidth: 1,
                    barThickness: 20,
                    categoryPercentage: 0.4, // Adjust category spacing
                    barPercentage: 0.8 // Adjust bar width
                }
            ]
        },
                options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            pointStyle: 'circle',
                            font: {
                                size: 14,
                                weight: 'bold'
                            },
                            color: '#000000'
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(tooltipItem) {
                                return tooltipItem.dataset.label + ': ' + tooltipItem.raw;
                            }
                        },
                        backgroundColor: 'rgba(0, 0, 0)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: '#000000',
                        borderWidth: 1
                    }
                },
                layout: {
                    padding: {
                        left: 10,
                        right: 10,
                        top: 10,
                        bottom: 30 // Increased padding at the bottom to move the chart down
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Complaints',
                            color: '#000000',
                            font: {
                                size: 14,
                                weight: 'bold'
                            },
                            padding: {
                                top: 10
                            }
                        },
                        ticks: {
                            stepSize: 1,
                            color: '#000000',
                            font: {
                                size: 15,
                                weight: 'bold'
                            }
                        },
                        grid: {
                            drawOnChartArea: false,
                            drawBorder: true,
                            color: '#000000',
                            borderWidth: 3
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Year',
                            color: '#000000',
                            font: {
                                size: 18,
                                weight: 'bold'
                            },
                            padding: {
                                top: 10
                            }
                        },
                        ticks: {
                            color: '#000000',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        grid: {
                            drawOnChartArea: false,
                            drawBorder: true,
                            color: '#000000',
                            borderWidth: 3
                        },
                        categoryPercentage: 0.5,
                        barPercentage: 0.4
                    }
                }
            }
    });
    const ctxPie = document.getElementById('totalComplaintsPieChart').getContext('2d');
    new Chart(ctxPie, {
    type: 'pie',
    data: {
        labels: ['Open Complaints', 'Closed Complaints'],
        datasets: [{
            label: 'Total Complaints',
            data: [totalOpen, totalClosed],
            backgroundColor: ['rgba(0, 0, 128)', 'rgb(0, 128, 0)'],
            borderColor: ['#FFFFFF', '#FFFFFF'],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true, // Ensure the chart keeps its aspect ratio
        aspectRatio: 1, // Set the aspect ratio (default is 2, reduce this to decrease size)
        layout: {
            padding: {
                top:10,
                bottom: 20
            }
        },
        plugins: {
            legend: {
                display: true,
                position: 'bottom',
                labels: {
                    usePointStyle: true,
                    pointStyle: 'circle',
                    font: {
                        size: 14,
                        weight: 'bold'
                    },
                    color: '#000000'
                }
            },
            tooltip: {
                callbacks: {
                    label: function(tooltipItem) {
                        const total = totalOpen + totalClosed;
                        const value = tooltipItem.raw;
                        const percentage = ((value / total) * 100).toFixed(2);
                        return `${tooltipItem.label}: ${value} (${percentage}%)`;
                    }
                },
                backgroundColor: 'rgba(0, 0, 0)',
                titleColor: '#fff',
                bodyColor: '#fff',
                borderColor: '#000000',
                borderWidth: 1
            },
            datalabels: {
                color: function(context) {
                    return context.dataIndex === 0 ? 'blue' : 'pink';
                },
                formatter: function(value, context) {
                    const dataset = context.dataset;
                    const total = dataset.data.reduce((acc, val) => acc + val, 0);
                    const percentage = (value / total * 100).toFixed(2) + '%';
                    return percentage;
                },
                anchor: 'center',
                align: 'center',
                font: {
                    size: 16,
                    weight: 'bold'
                },
                padding: {
                    top: 10,
                    bottom: 10
                }
            }
        },
        animation: {
            animateScale: true,
            animateRotate: true
        }
    }
});
</script>
</body>
</html>
